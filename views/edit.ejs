<!DOCTYPE html>
<html>
<head>
  <title>Edit Invoice</title>
  <style>
    .item { margin-bottom: 10px; }
    .item input { margin-right: 5px; }
    .remove-btn { color: red; cursor: pointer; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>Edit Invoice <%= invoice.invoice_id %></h1>

  <form action="/invoices/<%= invoice.id %>/edit" method="POST">
    <label>Invoice To:
      <input name="invoice_to" value="<%= invoice.invoice_to %>" required />
    </label><br/>

    <label>Date:
      <input type="date" name="inv_date" value="<%= new Date(invoice.inv_date).toLocaleDateString().split('T')[0] %>" required />
    <!-- <input type="date" name="inv_date" value="<%= invoice.inv_date %>" required />  -->
    </label><br/>
    
    <h3>Items</h3>

    <div id="items">
      <% items.forEach((item) => { %>
        <div class="item" data-item-id="<%= item.id %>">
          <input type="hidden" name="item_ids[]" value="<%= item.id %>" />
          <input name="details[]" value="<%= item.details %>" required />
          <input name="quantity[]" type="number" value="<%= item.quantity %>" required />
          <input name="rate_per[]" type="number" step="0.01" value="<%= item.rate_per %>" required />
          <span class="remove-btn" onclick="deleteItem(this, <%= item.id %>)">❌</span>
        </div>
      <% }) %>
    </div>

    <button type="button" onclick="addRow()">+ Add Item</button>
    <br/><br/>

    <button type="submit">Update Invoice</button>
    <button type="button" onClick="goHome()">HOME</button>
    <button type="button" onClick="goBack()">BACK</button>

  </form>

  <script>

    //go to home page
    function goHome(){
        window.location.href='/homepage';
    }

    //go back to list of invoices page
    function goBack(){
    
        window.location.href='/invoices';
    }

    // add new row of items
    function addRow() {
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <input type="hidden" name="item_ids[]" value="">
        <input name="details[]" placeholder="Details" required />
        <input name="quantity[]" type="number" placeholder="Qty" required />
        <input name="rate_per[]" type="number" step="0.01" placeholder="Rate" required />
        <span class="remove-btn" onclick="this.parentElement.remove()">❌</span>
        <br/>
      `;
      document.getElementById('items').appendChild(row);
    }

    //delete a row of items
    function deleteItem(button, itemId) {
      if (confirm('Are you sure you want to delete this item?')) {
        fetch(`/items/${itemId}/delete`, { method: 'DELETE' })
          .then(response => {
            if (response.ok) {
              button.parentElement.remove();
            } else {
              alert('Failed to delete item.');
            }
          })
          .catch(err => {
            console.error(err);
            alert('Error deleting item.');
          });
      }
    }
  </script>
</body>
</html>
